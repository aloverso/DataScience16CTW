<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        <script src="http://benschmidt.org/colorbar/colorbar.js"></script>
        <script src="http://fgnass.github.io/spin.js/spin.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <style>
            body {
                margin: 50px;
                font-family: Arial;
            }

            ul li {
                list-style: none;
                display: inline;
                text-align: center;
            }

            button {
              background-color: transparent;
              position: relative;
              border: none;
              font-size: 16px;
              transition: color 0.5s, transform 0.2s, background-color 0.2s;
              border-radius: 3px;
              margin: 0 10px;
              padding: 10px 20px;
              border: 2px solid #d4d4d4;
            }

            button.active {
              background-color: #e8e8e8;
              position: relative;
              border: none;
              font-size: 16px;
              border-radius: 3px;
              margin: 0 10px;
              padding: 10px 20px;
              border: 2px solid #d4d4d4;
            }

            button:hover {
                border: 2px solid #1b1b20;
            }

            #tooltip {
                position: absolute;
                padding: 10px;
                width: 250px;
                height: 400px;
                /*background-color: white;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;*/
                top: 25%;
                right: 20%;
                word-wrap: break-word;
            }

            #tooltip.hidden {
                display: none;
            }

            #tooltip p {
                margin: 0;
                font-family: sans-serif;
                font-size: 16px;
                line-height: 20px;
            }
        </style>
    </head>
    <body>
        <h1>How Hard is it for a Woman to Get an Abortion?</h1>
        <div id="foo"></div>
        <div id="tooltip" class="hidden">
            <p><span id="header"><strong>City Name></strong></span></p>
            <p><span id="drivetime"></span></p>
            <p><span id="hoteltime"></span></p>
            </br>
            <p><span id="gascost"></span></p>
            <p><span id="hotelcost"></span></p>
            <p><span id="abcost"></span></p>
            <p><span id="wageloss"></span></p>
            <hr>
            <p><span id="totalcost"></span></p>
        </div>
        <ul>
        <li><button id="totaltime" onclick="draw('totaltime')">Total Time Spent</button></li>
        <li><button class="active" id="gasprice" onclick="draw('gasprice')">Gas Price</button></li>
        <li><button id="drivetime" onclick="draw('drivetime')">Drive Time</button></li>
        <li><button id="totaldrivetime" onclick="draw('totaldrivetime')">Roundtrip Drive Time</button></li>
        <li><button id="hotelnights" onclick="draw('hotelnights')">Drive Time</button></li>
        </ul>
       <!--  <svg width="500" height="50">
            <rect x="0" y="0" width="30" height="30" fill="purple"/>
            <rect x="20" y="5" width="30" height="30" fill="blue"/>
            <rect x="40" y="10" width="30" height="30" fill="green"/>
            <rect x="60" y="15" width="30" height="30" fill="yellow"/>
            <rect x="80" y="20" width="30" height="30" fill="red"/>

            <circle cx="25" cy="25" r="20" fill="rgba(128, 0, 128, 1.0)"/>
            <circle cx="50" cy="25" r="20" fill="rgba(0, 0, 255, 0.75)"/>
            <circle cx="75" cy="25" r="20" fill="rgba(0, 255, 0, 0.5)"/>
            <circle cx="100" cy="25" r="20" fill="rgba(255, 255, 0, 0.25)"/>
            <circle cx="125" cy="25" r="20" fill="rgba(255, 0, 0, 0.1)"/>
        </svg> -->
        
        <script type="text/javascript">

            var opts = {
              lines: 11 // The number of lines to draw
            , length: 28 // The length of each line
            , width: 14 // The line thickness
            , radius: 42 // The radius of the inner circle
            , scale: 1 // Scales overall size of the spinner
            , corners: 1 // Corner roundness (0..1)
            , color: '#000' // #rgb or #rrggbb or array of colors
            , opacity: 0.25 // Opacity of the lines
            , rotate: 0 // The rotation offset
            , direction: 1 // 1: clockwise, -1: counterclockwise
            , speed: 1 // Rounds per second
            , trail: 60 // Afterglow percentage
            , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
            , zIndex: 2e9 // The z-index (defaults to 2000000000)
            , className: 'spinner' // The CSS class to assign to the spinner
            , top: '50%' // Top position relative to parent
            , left: '50%' // Left position relative to parent
            , shadow: false // Whether to render a shadow
            , hwaccel: false // Whether to use hardware acceleration
            , position: 'absolute' // Element positioning
            }
            var target = document.getElementById('foo');
            var spinner = new Spinner(opts);
           // target.appendChild(spinner.el)

            draw("totaltime");

           //  var w = 500;
           //  var h = 200;
           //  var dataset = [ 5, 10, 15, 20, 25, 30 ];
           //  var svg = d3.select("body").append("svg");
           //  svg.attr("width", w)
           //      .attr("height", h);
           //  var circles = svg.selectAll("circle")
           //      .data(dataset)
           //      .enter()
           //      .append("circle");
           //  circles.attr("cx", function(d, i) {
           //      return (i * 50) + 30;
           //  })
           // .attr("cy", h/2)
           // .attr("r", function(d) {
           //      return d;
           // })
           // .attr("fill", function(d) {
           //      var fill = "rgba("+d*8+", 0, 0, .5)";
           //      return fill;
           // });
            //Width and height

            function draw(column) {

                $('.active').removeClass('active');

                //add the active class to the link we clicked
                $("button#"+column).addClass('active');

                spinner.spin(target);

                console.log("starting drawing");
            var w = 1200;
            var h = 1000;

            abbrevs = { "AL":"Alabama",
                        "AK":"Alaska",
                        "AZ":"Arizona",
                        "AR":"Arkansas",
                        "CA":"California",
                        "CO":"Colorado",
                        "CT":"Connecticut",
                        "DE":"Delaware",
                        "DC":"District of Columbia",
                        "FL":"Florida",
                        "GA":"Georgia",
                        "HI":"Hawaii",
                        "ID":"Idaho",
                        "IL":"Illinois",
                        "IN":"Indiana",
                        "IA":"Iowa",
                        "KS":"Kansas",
                        "KY":"Kentucky",
                        "LA":"Louisiana",
                        "ME":"Maine",
                        "MD":"Maryland",
                        "MA":"Massachusetts",
                        "MI":"Michigan",
                        "MN":"Minnesota",
                        "MS":"Mississippi",
                        "MO":"Missouri",
                        "MT":"Montana",
                        "NE":"Nebraska",
                        "NV":"Nevada",
                        "NH":"New Hampshire",
                        "NJ":"New Jersey",
                        "NM":"New Mexico",
                        "NY":"New York",
                        "NC":"North Carolina",
                        "ND":"North Dakota",
                        "OH":"Ohio",
                        "OK":"Oklahoma",
                        "OR":"Oregon",
                        "PA":"Pennsylvania",
                        "RI":"Rhode Island",
                        "SC":"South Carolina",
                        "SD":"South Dakota",
                        "TN":"Tennessee",
                        "TX":"Texas",
                        "UT":"Utah",
                        "VT":"Vermont",
                        "VA":"Virginia",
                        "WA":"Washington",
                        "WV":"West Virginia",
                        "WI":"Wisconsin",
                        "WY":"Wyoming" }
            //Define default path generator

            var projection = d3.geo.albersUsa()
                       .translate([w/2.5, h/3.5]);
                       //.scale([500]);

            var path = d3.geo.path()
                 .projection(projection);

            d3.select("svg").remove();
            //Create SVG element
            var svg = d3.select("body")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);

            wt = 200
            ht = 400
            // var svgtt = d3.select("#tooltip")
            //         .append("svg")
            //         .attr("width", wt)
            //         .attr("height", ht);

            d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/cities_clean.csv", function(data) {
                //console.log(data);
                var color = d3.scale.quantile()
                    .range(["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"])
                
                var vals = [];
                data.forEach(function(d) {
                    vals.push(d[column]);
                });

                color.domain(vals);

                console.log(color.quantiles());

                // for (i=0; i<30; i++) {
                //     console.log(color(i));
                // }

               // console.log(d3.quantile(data['totaldrivetime'], 0.25));
                    // d3.min(data, function(d) { return d.totaldrivetime; }),
                    // d3.max(data, function(d) { return d.totaldrivetime; })
                // ]);

                // colorbar = Colorbar()
                //   .origin([30,80])
                //   .scale(color)
                //   .barlength(300)
                //   .thickness(30)
                //   .orient("vertical");

                //   bar =  d3.selectAll("svg").append("g").attr("id","colorbar");
                //   pointer = d3.selectAll("#colorbar").call(colorbar);

                d3.json("https://raw.githubusercontent.com/alignedleft/d3-book/master/chapter_12/us-states.json", function(json) {

                    //Merge the ag. data and GeoJSON
                    //Loop through once for each ag. data value
                    // for (var i = 0; i < data.length; i++) {

                    //     //Grab state name
                    //     var dataState = data[i].state;

                    //     //Grab data value, and convert from string to float
                    //     var dataValue = parseFloat(data[i].numlaws);
                    //     console.log(dataValue);

                    //     //Find the corresponding state inside the GeoJSON
                    //     for (var j = 0; j < json.features.length; j++) {

                    //         var jsonState = json.features[j].properties.name;

                    //         if (dataState == jsonState) {

                    //             //Copy the data value into the JSON
                    //             json.features[j].properties.value = dataValue;

                    //             //Stop looking through the JSON
                    //             break;
                    //         }
                    //     }
                    // }

                    spinner.stop();

                    svg.selectAll("path")
                       .data(json.features)
                       .enter()
                       .append("path")
                       .attr("d", path)
                       .style("fill", function(d) {
                            //Get data value
                            var value = d.properties.value;
                            if (value) {
                                //If value exists…
                                return color(value);
                            } else {
                                //If value is undefined…
                                return "#ccc";
                            }
                        });

                    function formatHours(hours) {
                        var h = Math.floor(hours);
                        var m = Math.floor(hours*60 % 60);
                        return h+"h"+m+"m";
                    }

                    // MAKES COLOR HEATMAP

                        svg.selectAll("circle")
                           .data(data)
                           .enter()
                           .append("circle")
                           .attr("cx", function(d) {
                                   return projection([d.lng, d.lat])[0];
                           })
                           .attr("cy", function(d) {
                                   return projection([d.lng, d.lat])[1];
                           })
                           .attr("r", 3)
                           .style("fill", function(d) {
                                return color(d[column]);
                           })
                           .style("opacity", 0.75)
                           .on("mouseover", function(d) {
                                console.log("mouse on");
                                //Get this bar's x/y values, then augment for the tooltip
                                // var xPosition = parseFloat(d3.select(this).attr("x"));
                                // var yPosition = parseFloat(d3.select(this).attr("y")) / 2 + h / 2;
                                
                                //Update the tooltip position and value
                                d3.select("#tooltip")
                                  // .style("left", xPosition + "px")
                                  // .style("top", yPosition + "px")
                                  .select("#header")
                                  .text(d.city + ", " +d.state);

                                var getHtml = function(amt, icon, label, units) {
                                    res = "";
                                    if (units === "hours") {
                                        amt = Math.round(amt*10)/10;
                                        res = label+amt+" hrs"+"</br>";
                                        for (i=0; i<amt; i++) {
                                            res+=icon;                                      
                                        }
                                    }
                                    else if (units === "dollars") {
                                        amt = Math.round(amt*100)/100;
                                        res = label+"$"+amt+"</br>";
                                        for (i=0; i<amt/10; i++) {
                                            res+=icon;                           
                                        }
                                    }
                                    
                                    return res;
                                };

                                d3.select("#tooltip")
                                  .select("#drivetime")
                                  .html(getHtml(d.totaldrivetime, "<i class='fa fa-car fa-fw'></i> ", "Driving Time: ","hours"));

                                d3.select("#tooltip")
                                  .select("#hoteltime")
                                  .html(getHtml(d.totaltime - d.totaldrivetime, "<i class='fa fa-hotel fa-fw'></i> ", "Time in Hotel: ","hours"));

                                d3.select("#tooltip")
                                  .select("#gascost")
                                  .html(getHtml(d.gascost, "<i class='material-icons'>local_gas_station</i> ", "Gas Cost: ","dollars"));

                                d3.select("#tooltip")
                                  .select("#gascost")
                                  .html(getHtml(d.gascost, "<i class='material-icons'>local_gas_station</i> ", "Gas Cost: ","dollars"));

                                d3.select("#tooltip")
                                  .select("#hotelcost")
                                  .html(getHtml(d.avghotelcost, "<i class='fa fa-hotel fa-fw'></i> ", "Hotel Cost: ","dollars"));

                                d3.select("#tooltip")
                                  .select("#abcost")
                                  .html(getHtml(d.minabcost, "<i class='fa fa-medkit fa-fw'></i> ", "Abortion Cost: ","dollars"));

                                d3.select("#tooltip")
                                  .select("#wageloss")
                                  .html(getHtml(d.wageloss, "<i class='fa fa-money fa-fw'></i> ", "Wages Lost During Process Time: ","dollars"));

                                var tcost = parseInt(d.gascost) + parseInt(d.avghotelcost)+parseInt(d.minabcost)+parseInt(d.wageloss);
                                d3.select("#tooltip")
                                  .select("#totalcost")
                                  .html("<b>Total Cost: </b>$"+tcost);

                                // d3.select("#tooltip")
                                //   .select("#totaltime")
                                //   .text(d.totaltime);

                                // d3.select("#tooltip")
                                //   .select("#gascost")
                                //   .text(d.totaltime);
                                // svgtt.append("rect")
                                //      .attr("width", 60)
                                //      .attr("height",d.totaltime*8);

                                //Show the tooltip
                                d3.select("#tooltip").classed("hidden", false);
                            })
                           .on("mouseout", function() {
                                //Hide the tooltip
                                d3.select("#tooltip").classed("hidden", true);
                                svgtt.selectAll("*").remove();
                            });
                           // .append("svg:title")
                           // .text(function(d) { 
                           //      var s = "If you lived in "+d.city+", "+d.state+", your abortion process would take "+formatHours(d.totaltime)+" total"
                           //      return s; 
                           //  });

                    // MAKES BUBBLE MAP

                    // var radius = d3.scale.sqrt()
                    // .domain([0, 200])
                    // .range([0, 15]);

                    // svg.selectAll("circle")
                    //        .data(data)
                    //        .enter()
                    //        .append("circle")
                    //        .attr("cx", function(d) {
                    //                return projection([d.lng, d.lat])[0];
                    //        })
                    //        .attr("cy", function(d) {
                    //                return projection([d.lng, d.lat])[1];
                    //        })
                    //        .attr("r", function(d) {
                    //             return (d.totaltime/2)
                    //        })
                    //        // .style("fill", function(d) {
                    //        //      return color(d.totaltime);
                    //        // })
                    //        .style("opacity", 0.3)
                    //        .style("stroke", "#fff")
                    //        .style("stroke-width",".5px")
                    //        .append("svg:title")
                    //        .text(function(d) { 
                    //             var s = "If you lived in "+d.city+", "+d.state+", your abortion process would take "+formatHours(d.totaltime)+" total"
                    //             return s; 
                    //         });

                    // STATE AVERAGES BAR CHART
                    // d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/stateavgs.csv", function(stateavgs) {

                    //         svg.selectAll("rect")
                    //             .data(stateavgs.sort(function(a, b){return b[column]-a[column]}))
                    //             .enter()
                    //             .append("rect")
                    //             .attr("x", w-w/6)
                    //             .attr("y", function(d,i) {
                    //                 return h/12 + i*18;
                    //             })
                    //             .attr("height", 15)
                    //             .attr("width", function(d) {
                    //                 return d[column]*8;
                    //             })
                    //             .attr("fill", function(d) {
                    //                 return color(d[column]);
                    //             });
                                
                    //         svg.selectAll("text")
                    //             .data(stateavgs.sort(function(a, b){return b[column]-a[column]}))
                    //             .enter()
                    //             .append("text")
                    //             .text(function(d) {
                    //                 return abbrevs[d.state];
                    //             })
                    //             .attr("x", w-w/6-5)
                    //             .attr("y", function(d,i) {
                    //                 return h/12 + 11 + i*18;
                    //             })
                    //             .attr("font-family", "sans-serif")
                    //             .attr("font-size", "11px")
                    //             .attr("text-anchor", "end");
                    //         svg.selectAll("labels")
                    //             .data(stateavgs.sort(function(a, b){return b[column]-a[column]}))
                    //             .enter()
                    //             .append("text")
                    //             .text(function(d) {
                    //                 return Math.round(d[column]*10)/10;
                    //             })
                    //             .attr("x", function(d) {
                    //                 return w-w/6+5+ d[column]*8;
                    //             })
                    //             .attr("y", function(d,i) {
                    //                 return h/12 + 11 + i*18;
                    //             })
                    //             .attr("font-family", "sans-serif")
                    //             .attr("font-size", "11px");
                    //         svg.append("text")
                    //             .text("Average Total Time by State (hrs)")
                    //             .attr("x",(w-w/6)+30)
                    //             .attr("y",h/12-20)
                    //             .attr("font-family", "sans-serif")
                    //             .attr("font-size", "14px")
                    //             .attr("text-anchor", "middle");
                            
                    // });

                    
                    // PLOT CLINIC LOCATIONS

                    // d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/ablocs.csv", function(ablocs) {
                    //     svg.selectAll("circle")
                    //        .data(ablocs)
                    //        .enter()
                    //        .append("circle")
                    //        .attr("cx", function(d) {
                    //                return projection([d.longitude, d.latitude])[0];
                    //        })
                    //        .attr("cy", function(d) {
                    //                return projection([d.longitude, d.latitude])[1];
                    //        })
                    //        .attr("r", 3)
                    //        .style("fill", "yellow")
                    //        .style("opacity", 0.75);
                    // });



                });
            });

            // //Load in GeoJSON data
            // d3.json("https://raw.githubusercontent.com/alignedleft/d3-book/master/chapter_12/us-states.json", function(json) {
                
            //     //Bind data and create one path per GeoJSON feature
            //     svg.selectAll("path")
            //        .data(json.features)
            //        .enter()
            //        .append("path")
            //        .attr("d", path)
            //        .style("fill", "steelblue");
        
            // });
            console.log("ending drawing");

        }


        </script>
    </body>
</html>     