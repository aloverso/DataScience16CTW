<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        <script src="http://benschmidt.org/colorbar/colorbar.js"></script>
    </head>
    <body>

        <button id="update" onclick="draw('gasprice')">Gas Price</button>
        <button id="update" onclick="draw('drivetime')">Drive Time</button>
        <button id="update" onclick="draw('totaldrivetime')">Roundtrip Drive Time</button>
        <button id="update" onclick="draw('totaltime')">Total Time Spent</button>
        <button id="update" onclick="draw('drivetime')">Drive Time</button>
       <!--  <svg width="500" height="50">
            <rect x="0" y="0" width="30" height="30" fill="purple"/>
            <rect x="20" y="5" width="30" height="30" fill="blue"/>
            <rect x="40" y="10" width="30" height="30" fill="green"/>
            <rect x="60" y="15" width="30" height="30" fill="yellow"/>
            <rect x="80" y="20" width="30" height="30" fill="red"/>

            <circle cx="25" cy="25" r="20" fill="rgba(128, 0, 128, 1.0)"/>
            <circle cx="50" cy="25" r="20" fill="rgba(0, 0, 255, 0.75)"/>
            <circle cx="75" cy="25" r="20" fill="rgba(0, 255, 0, 0.5)"/>
            <circle cx="100" cy="25" r="20" fill="rgba(255, 255, 0, 0.25)"/>
            <circle cx="125" cy="25" r="20" fill="rgba(255, 0, 0, 0.1)"/>
        </svg> -->
        
        <script type="text/javascript">

            draw("totaltime");

           //  var w = 500;
           //  var h = 200;
           //  var dataset = [ 5, 10, 15, 20, 25, 30 ];
           //  var svg = d3.select("body").append("svg");
           //  svg.attr("width", w)
           //      .attr("height", h);
           //  var circles = svg.selectAll("circle")
           //      .data(dataset)
           //      .enter()
           //      .append("circle");
           //  circles.attr("cx", function(d, i) {
           //      return (i * 50) + 30;
           //  })
           // .attr("cy", h/2)
           // .attr("r", function(d) {
           //      return d;
           // })
           // .attr("fill", function(d) {
           //      var fill = "rgba("+d*8+", 0, 0, .5)";
           //      return fill;
           // });
            //Width and height

            function draw(column) {

                console.log("starting drawing");
            var w = 1200;
            var h = 1000;

            abbrevs = {"AL":"Alabama",
"AK":"Alaska",
"AZ":"Arizona",
"AR":"Arkansas",
"CA":"California",
"CO":"Colorado",
"CT":"Connecticut",
"DE":"Delaware",
"DC":"District of Columbia",
"FL":"Florida",
"GA":"Georgia",
"HI":"Hawaii",
"ID":"Idaho",
"IL":"Illinois",
"IN":"Indiana",
"IA":"Iowa",
"KS":"Kansas",
"KY":"Kentucky",
"LA":"Louisiana",
"ME":"Maine",
"MD":"Maryland",
"MA":"Massachusetts",
"MI":"Michigan",
"MN":"Minnesota",
"MS":"Mississippi",
"MO":"Missouri",
"MT":"Montana",
"NE":"Nebraska",
"NV":"Nevada",
"NH":"New Hampshire",
"NJ":"New Jersey",
"NM":"New Mexico",
"NY":"New York",
"NC":"North Carolina",
"ND":"North Dakota",
"OH":"Ohio",
"OK":"Oklahoma",
"OR":"Oregon",
"PA":"Pennsylvania",
"RI":"Rhode Island",
"SC":"South Carolina",
"SD":"South Dakota",
"TN":"Tennessee",
"TX":"Texas",
"UT":"Utah",
"VT":"Vermont",
"VA":"Virginia",
"WA":"Washington",
"WV":"West Virginia",
"WI":"Wisconsin",
"WY":"Wyoming" }
            //Define default path generator

            var projection = d3.geo.albersUsa()
                       .translate([w/2.5, h/3.5]);
                       //.scale([500]);

            var path = d3.geo.path()
                 .projection(projection);

            d3.select("svg").remove();
            //Create SVG element
            var svg = d3.select("body")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);

            d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/cities.csv", function(data) {
                //console.log(data);
                var color = d3.scale.quantile()
                    .range(["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"])
                
                var vals = [];
                data.forEach(function(d) {
                    vals.push(d[column]);
                });

                color.domain(vals);

                //console.log(color.quantiles());

                // for (i=0; i<30; i++) {
                //     console.log(color(i));
                // }

               // console.log(d3.quantile(data['totaldrivetime'], 0.25));
                    // d3.min(data, function(d) { return d.totaldrivetime; }),
                    // d3.max(data, function(d) { return d.totaldrivetime; })
                // ]);

                // colorbar = Colorbar()
                //   .origin([30,80])
                //   .scale(color)
                //   .barlength(300)
                //   .thickness(30)
                //   .orient("vertical");

                //   bar =  d3.selectAll("svg").append("g").attr("id","colorbar");
                //   pointer = d3.selectAll("#colorbar").call(colorbar);

                d3.json("https://raw.githubusercontent.com/alignedleft/d3-book/master/chapter_12/us-states.json", function(json) {

                    //Merge the ag. data and GeoJSON
                    //Loop through once for each ag. data value
                    // for (var i = 0; i < data.length; i++) {

                    //     //Grab state name
                    //     var dataState = data[i].state;

                    //     //Grab data value, and convert from string to float
                    //     var dataValue = parseFloat(data[i].numlaws);
                    //     console.log(dataValue);

                    //     //Find the corresponding state inside the GeoJSON
                    //     for (var j = 0; j < json.features.length; j++) {

                    //         var jsonState = json.features[j].properties.name;

                    //         if (dataState == jsonState) {

                    //             //Copy the data value into the JSON
                    //             json.features[j].properties.value = dataValue;

                    //             //Stop looking through the JSON
                    //             break;
                    //         }
                    //     }
                    // }

                    svg.selectAll("path")
                       .data(json.features)
                       .enter()
                       .append("path")
                       .attr("d", path)
                       .style("fill", function(d) {
                            //Get data value
                            var value = d.properties.value;
                            if (value) {
                                //If value exists…
                                return color(value);
                            } else {
                                //If value is undefined…
                                return "#ccc";
                            }
                        });

                    function formatHours(hours) {
                        var h = Math.floor(hours);
                        var m = Math.floor(hours*60 % 60);
                        return h+"h"+m+"m";
                    }

                    // MAKES COLOR HEATMAP

                    svg.selectAll("circle")
                           .data(data)
                           .enter()
                           .append("circle")
                           .attr("cx", function(d) {
                                   return projection([d.lng, d.lat])[0];
                           })
                           .attr("cy", function(d) {
                                   return projection([d.lng, d.lat])[1];
                           })
                           .attr("r", 3)
                           .style("fill", function(d) {
                                return color(d[column]);
                           })
                           .style("opacity", 0.75)
                           .append("svg:title")
                           .text(function(d) { 
                                var s = "If you lived in "+d.city+", "+d.state+", your abortion process would take "+formatHours(d.totaltime)+" total"
                                return s; 
                            });

                    // MAKES BUBBLE MAP

                    // var radius = d3.scale.sqrt()
                    // .domain([0, 200])
                    // .range([0, 15]);

                    // svg.selectAll("circle")
                    //        .data(data)
                    //        .enter()
                    //        .append("circle")
                    //        .attr("cx", function(d) {
                    //                return projection([d.lng, d.lat])[0];
                    //        })
                    //        .attr("cy", function(d) {
                    //                return projection([d.lng, d.lat])[1];
                    //        })
                    //        .attr("r", function(d) {
                    //             return (d.totaltime/2)
                    //        })
                    //        // .style("fill", function(d) {
                    //        //      return color(d.totaltime);
                    //        // })
                    //        .style("opacity", 0.3)
                    //        .style("stroke", "#fff")
                    //        .style("stroke-width",".5px")
                    //        .append("svg:title")
                    //        .text(function(d) { 
                    //             var s = "If you lived in "+d.city+", "+d.state+", your abortion process would take "+formatHours(d.totaltime)+" total"
                    //             return s; 
                    //         });

                    d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/stateavgs.csv", function(stateavgs) {
                            svg.selectAll("rect")
                                .data(stateavgs.sort(function(a, b){return b[column]-a[column]}))
                                .enter()
                                .append("rect")
                                .attr("x", w-w/8)
                                .attr("y", function(d,i) {
                                    return h/12 + i*18;
                                })
                                .attr("height", 15)
                                .attr("width", function(d) {
                                    return d[column]*10;
                                })
                                .attr("fill", function(d) {
                                    return color(d[column]);
                                });
                                
                            svg.selectAll("text")
                                .data(stateavgs.sort(function(a, b){return b[column]-a[column]}))
                                .enter()
                                .append("text")
                                .text(function(d) {
                                    return abbrevs[d.state];
                                })
                                .attr("x", w-w/8-5)
                                .attr("y", function(d,i) {
                                    return h/12 + 11 + i*18;
                                })
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "11px")
                                .attr("text-anchor", "end");
                            svg.append("text")
                                .text("Average Total Time by State")
                                .attr("x",(w-w/8)+30)
                                .attr("y",h/12-20)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "14px")
                                .attr("text-anchor", "middle");
                            
                    });

                    // d3.csv("https://raw.githubusercontent.com/aloverso/DataScience16CTW/master/ablocs.csv", function(ablocs) {
                    //     svg.selectAll("circle")
                    //        .data(ablocs)
                    //        .enter()
                    //        .append("circle")
                    //        .attr("cx", function(d) {
                    //                return projection([d.longitude, d.latitude])[0];
                    //        })
                    //        .attr("cy", function(d) {
                    //                return projection([d.longitude, d.latitude])[1];
                    //        })
                    //        .attr("r", 3)
                    //        .style("fill", "yellow")
                    //        .style("opacity", 0.75);
                    // });

                });
            });

            // //Load in GeoJSON data
            // d3.json("https://raw.githubusercontent.com/alignedleft/d3-book/master/chapter_12/us-states.json", function(json) {
                
            //     //Bind data and create one path per GeoJSON feature
            //     svg.selectAll("path")
            //        .data(json.features)
            //        .enter()
            //        .append("path")
            //        .attr("d", path)
            //        .style("fill", "steelblue");
        
            // });
            console.log("ending drawing");
        }


        </script>
    </body>
</html>     